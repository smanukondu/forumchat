
-- ===========================
-- Table of FORUM_USER_PROFILE
-- ===========================

CREATE TABLE FORUM_USER_PROFILE (
	USER_ID INT GENERATED BY DEFAULT AS IDENTITY (START WITH 1, INCREMENT BY 1) NOT NULL, 
	USER_NAME VARCHAR(30) NOT NULL, 
	USER_PASSWORD VARCHAR(200) NOT NULL, 
	USER_ALIAS VARCHAR(30) NOT NULL, 
	USER_EMAIL VARCHAR(50) NOT NULL, 
	USER_TYPE VARCHAR(50) NOT NULL, 
	USER_LEVEL INT NOT NULL, 
	USER_SIGNATURE VARCHAR(100) NOT NULL, 
	USER_AVATAR_PIC VARCHAR(200) NOT NULL, 
	USER_REGISTER_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL, 
	USER_LOGIN_STATUS INT DEFAULT 0 NOT NULL,
	CONSTRAINT pk_FORUM_USER_PROFILE PRIMARY KEY (USER_ID)
);


-- ===================
-- Table of FORUM_POST
-- ===================

CREATE TABLE FORUM_POST (
	POST_ID INT GENERATED BY DEFAULT AS IDENTITY (START WITH 1, INCREMENT BY 1) NOT NULL, 
	POST_TOPIC VARCHAR(150) NOT NULL, 
	POST_CONTENT VARCHAR(1000) NOT NULL, 
	POST_ATTACHMENT_IMG VARCHAR(200), 
	POST_MARK INT DEFAULT 0 NOT NULL, 
	POST_COMMENT_NUM INT DEFAULT 0 NOT NULL, 
	POST_LEVEL INT DEFAULT 0 NOT NULL, 
	POST_USER_ID INT DEFAULT 0 NOT NULL, 
	POST_TIME TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL, 
	CONSTRAINT pk_FORUM_POST PRIMARY KEY (POST_ID), 
	CONSTRAINT fk_FORUM_POST_FORUM_USER_PROFILE FOREIGN KEY (POST_USER_ID) REFERENCES FORUM_USER_PROFILE (USER_ID)
);

CREATE INDEX idx_FORUM_POST_FORUM_USER_PROFILE ON FORUM_POST (POST_USER_ID);


-- ===========================
-- Table of FORUM_POST_COMMENT
-- ===========================

CREATE TABLE FORUM_POST_COMMENT (
	POST_COMMENT_ID INT GENERATED BY DEFAULT AS IDENTITY (START WITH 1, INCREMENT BY 1) NOT NULL, 
	POST_COMMENT_POST_ID INT DEFAULT 0 NOT NULL, 
	POST_COMMENT_CONTENT VARCHAR(1000) NOT NULL, 
	POST_COMMENT_USER_ID INT DEFAULT 0 NOT NULL, 
	POST_COMMENT_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL, 
	POST_COMMENT_MARK INT DEFAULT 0 NOT NULL, 
	CONSTRAINT pk_FORUM_POST_COMMENT PRIMARY KEY (POST_COMMENT_ID), 
	CONSTRAINT fk_FORUM_POST_COMMENT_FORUM_POST FOREIGN KEY (POST_COMMENT_POST_ID) REFERENCES FORUM_POST (POST_ID), 
	CONSTRAINT fk_FORUM_POST_COMMENT_FORUM_USER_PROFILE FOREIGN KEY (POST_COMMENT_USER_ID) REFERENCES FORUM_USER_PROFILE (USER_ID)
);

CREATE INDEX idx_FORUM_POST_COMMENT_FORUM_POST ON FORUM_POST_COMMENT (POST_COMMENT_POST_ID);
CREATE INDEX idx_FORUM_POST_COMMENT_FORUM_USER_PROFILE ON FORUM_POST_COMMENT (POST_COMMENT_USER_ID);


-- ======================
-- Table of FORUM_MESSAGE
-- ======================

CREATE TABLE FORUM_MESSAGE (
	MESSAGE_ID INT GENERATED BY DEFAULT AS IDENTITY (START WITH 1, INCREMENT BY 1) NOT NULL, 
	MESSAGE_SOURCE_USER_ID INT DEFAULT 0 NOT NULL, 
	MESSAGE_DESTINATION_USER_ID INT DEFAULT 0 NOT NULL, 
	MESSAGE_CONTENT VARCHAR(500) NOT NULL, 
	MESSAGE_TIME TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL, 
	MESSAGE_READ_FLAG INT DEFAULT 0 NOT NULL, 
	CONSTRAINT pk_FORUM_MESSAGE PRIMARY KEY (MESSAGE_ID), 
	CONSTRAINT fk_FORUM_MESSAGE_FORUM_USER_PROFILE1 FOREIGN KEY (MESSAGE_SOURCE_USER_ID) REFERENCES FORUM_USER_PROFILE (USER_ID), 
	CONSTRAINT fk_FORUM_MESSAGE_FORUM_USER_PROFILE2 FOREIGN KEY (MESSAGE_DESTINATION_USER_ID) REFERENCES FORUM_USER_PROFILE (USER_ID) 
);

CREATE INDEX idx_FORUM_MESSAGE_FORUM_USER_PROFILE1 ON FORUM_MESSAGE (MESSAGE_SOURCE_USER_ID);
CREATE INDEX idx_FORUM_MESSAGE_FORUM_USER_PROFILE2 ON FORUM_MESSAGE (MESSAGE_DESTINATION_USER_ID);


-- ==========================
-- Table of FORUM_FRIEND_LINK
-- ==========================

CREATE TABLE FORUM_FRIEND_LINK (
	FRIEND_LINK_ID INT GENERATED BY DEFAULT AS IDENTITY (START WITH 1, INCREMENT BY 1) NOT NULL, 
	FRIEND_LINK_HOST_USER_ID INT DEFAULT 0 NOT NULL, 
	FRIEND_LINK_CUST_USER_ID INT DEFAULT 0 NOT NULL, 
	FRIEND_LINK_MAP_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL, 
	CONSTRAINT pk_FORUM_FRIEND_LINK PRIMARY KEY (FRIEND_LINK_ID), 
	CONSTRAINT fk_FORUM_FRIEND_LINK_FORUM_USER_PROFILE1 FOREIGN KEY (FRIEND_LINK_HOST_USER_ID) REFERENCES FORUM_USER_PROFILE (USER_ID), 
	CONSTRAINT fk_FORUM_FRIEND_LINK_FORUM_USER_PROFILE2 FOREIGN KEY (FRIEND_LINK_CUST_USER_ID) REFERENCES FORUM_USER_PROFILE (USER_ID)
);

CREATE INDEX idx_FORUM_FRIEND_LINK_FORUM_USER_PROFILE1 ON FORUM_FRIEND_LINK (FRIEND_LINK_HOST_USER_ID);
CREATE INDEX idx_FORUM_FRIEND_LINK_FORUM_USER_PROFILE2 ON FORUM_FRIEND_LINK (FRIEND_LINK_CUST_USER_ID);


-- ===================================
-- Table of FORUM_FRIEND_JOINT_REQUEST
-- ===================================

CREATE TABLE FORUM_FRIEND_JOINT_REQUEST (
	FRIEND_JOINT_REQUEST_ID INT GENERATED BY DEFAULT AS IDENTITY (START WITH 1, INCREMENT BY 1) NOT NULL, 
	FRIEND_JOINT_REQUEST_FROM_USER_ID INT DEFAULT 0 NOT NULL, 
	FRIEND_JOINT_REQUEST_TO_USER_ID INT DEFAULT 0 NOT NULL, 
	FRIEND_JOINT_REQUEST_REMARK VARCHAR(100), 
	FRIEND_JOINT_REQUEST_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL, 
	FRIEND_JOINT_REQUEST_STATUS VARCHAR(30) NOT NULL, 
	CONSTRAINT pk_FORUM_FRIEND_JOINT_REQUEST PRIMARY KEY (FRIEND_JOINT_REQUEST_ID), 
	CONSTRAINT fk_FORUM_FRIEND_JOINT_REQUEST_FORUM_USER_PROFILE1 FOREIGN KEY (FRIEND_JOINT_REQUEST_FROM_USER_ID) REFERENCES FORUM_USER_PROFILE (USER_ID), 
	CONSTRAINT fk_FORUM_FRIEND_JOINT_REQUEST_FORUM_USER_PROFILE2 FOREIGN KEY (FRIEND_JOINT_REQUEST_TO_USER_ID) REFERENCES FORUM_USER_PROFILE (USER_ID) 
);

CREATE INDEX idx_FORUM_FRIEND_JOINT_REQUEST_FORUM_USER_PROFILE1 ON FORUM_FRIEND_JOINT_REQUEST (FRIEND_JOINT_REQUEST_FROM_USER_ID);
CREATE INDEX idx_FORUM_FRIEND_JOINT_REQUEST_FORUM_USER_PROFILE2 ON FORUM_FRIEND_JOINT_REQUEST (FRIEND_JOINT_REQUEST_TO_USER_ID);


CREATE VIEW V_POST_HAS_COMMENT AS 
SELECT rownum() ID, count(*) NUM 
FROM FORUM_POST AS post JOIN FORUM_POST_COMMENT AS comment ON post.POST_ID = comment.POST_COMMENT_POST_ID 
WHERE lower(post.POST_TOPIC) LIKE '%test%';
